!function(){var e=window.hasOwnProperty("LB")?window.LB.api_host:"",t=document.referrer,n=window.hasOwnProperty("LB")?window.LB.blog._id:"";e+="api/analytics/hit";var r=function(e,t,n){var r="",i=new Date;n&&(i.setTime(i.getTime()+24*n*60*60*1e3),r="; expires="+i.toUTCString()),document.cookie=e+"="+t+r+"; path=/"},i=function(e){for(var t=e+"=",n=document.cookie.split(";"),r=0;r<n.length;r++){for(var i=n[r];" "==i.charAt(0);)i=i.substring(1,i.length);if(0==i.indexOf(t))return i.substring(t.length,i.length)}return null},o=function(){var i=new XMLHttpRequest,o=JSON.stringify({context_url:t,blog_id:n});i.open("POST",e),i.setRequestHeader("Content-Type","application/json"),i.onload=function(){200==i.status&&r("hit",o,2)},i.send(o)};i("hit")||o()}(),function(e){"use strict";e.module("liveblog-embed",["ngResource","angular-cache"]).constant("config",window.LB)}(angular),function(e){"use strict";function t(t){return function(n){var r="";return e.forEach(n,function(e,n){"original"!==n&&(r+=", "+t(e.href)+" "+e.width+"w")}),r.substring(2)}}function n(t){return function(n){if(n&&n.thumbnail)return t(n.thumbnail.href);var r,i="",o=!1;return e.forEach(n,function(e){r=parseInt(e["with"],10)*parseInt(e.height,10),(r<o||o===!1)&&(i=t(e.href),o=r)}),i}}function r(e,t,n){return function(r){return r.descriptionHtml=n.trustAsHtml(r.description),r.picture_url&&r.picture&&(r.picture_srcset=t(r.picture.renditions),r.picture_url=e(r.picture_url)),r}}function i(t,n,r){return t(n.api_host+'api/client_blogs/:blogId?embedded={"picture":1}',{blogId:n.blog._id},{get:{method:"GET",transformResponse:function(t){return t=e.fromJson(t),r(t)}}})}function o(t,n,r,i){return t(n.api_host+"api/client_users/:userId",{userId:"@id"},{get:{method:"GET",transformResponse:function(t){if(t=e.fromJson(t),t&&null!==t.picture_url){var n=i(t.avatar_renditions);t.picture_url=n?n:t.picture_url,t.picture_srcset=r(t.avatar_renditions)}return t}}})}function s(e,t){return e.original_creator=t._items?t._items[0]:t,!e.original_creator.byline&&e.byline&&(e.original_creator.byline=e.byline),!e.original_creator.sign_off&&e.sign_off&&(e.original_creator.sign_off=e.sign_off),e.original_creator}function a(t,n,r,i,o,a,c){function u(t){var n,a;if(r.get("usersCache"))n=r.get("usersCache"),a=r.get("refreshCache");else{var c=e.copy(f);c.onExpire=function(r,c){i.$apply(function(){o.get({userId:r}).$promise.then(function(i){var o=s(t,i),c=n.get(r);e.extend(c,o),n.put(r,c),a.put(r,{})})})},n=r.createCache("usersCache",{storageMode:"memory"}),a=r.createCache("refreshCache",c)}if(t.commenter)t.original_creator={display_name:t.commenter,sign_off:t.commenter,byline:t.commenter};else if(t.syndicated_creator)t.original_creator=t.syndicated_creator;else if(""!==t.original_creator&&"None"!==t.original_creator){var u=t.original_creator;if("string"!=typeof u)return t;n.get(u)?"function"==typeof n.get(u).then?n.get(u).then(function(e){n.put(u,s(t,e))}):s(t,n.get(u)):n.put(u,o.get({userId:t.original_creator}).$promise.then(function(e){return n.put(u,s(t,e)),a.put(u,{}),e}))}return t}return t(n.api_host+"api/client_blogs/:blogId/posts",{blogId:n.blog._id},{get:{transformResponse:function(t){return t=e.fromJson(t),t._items.forEach(function(t){t.mainItem=u(t.groups[1].refs[0].item),t.hasComments=_.reduce(t.groups[1].refs,function(e,t){return e||!_.isUndefined(t.item.commenter)},!1),t.fullDetails=t.hasComments,t.content_updated_date||(t.content_updated_date=t._updated),t.showUpdate=t.content_updated_date!==t.published_date&&!t.hasComments&&"comment"!==t.mainItem.item_type,e.isDefined(t.groups[1])&&(t.items=t.groups[1].refs.map(function(e){var n=e.item;return"image"==n.item_type&&n.meta&&n.meta.media&&(n.picture_url=c(n.meta.media.renditions.thumbnail.href),n.picture_srcset=a(n.meta.media.renditions)),t.fullDetails?(u(n),n.displayDate=n.meta&&n.meta._created||n._created):n.displayDate=t.published_date,n})),t=u(t)}),t}}})}function c(e,t){return e(t.api_host+"api/client_comments/")}function u(e,t){return e(t.api_host+"api/client_items/")}function l(e,t){return e(t.api_host+'api/client_advertisement_outputs/:id?embedded={"collection":1}',{id:"@id"})}function d(t,n){return t(n.api_host+"api/client_advertisements/:advertisementId",{advertisementId:"@id"},{get:{method:"GET",transformResponse:function(t){t=e.fromJson(t),t.item_type=t.type,t.group_type="freetype";var n={_id:t._id,mainItem:t,items:[t]};return n}}})}var f={deleteOnExpire:"aggressive",recycleFreq:12e4,maxAge:24e4,storageMode:"memory"};t.$inject=["fixProtocol"],n.$inject=["fixProtocol"],r.$inject=["fixProtocol","srcSet","$sce"],i.$inject=["$resource","config","transformBlog"],o.$inject=["$resource","config","srcSet","thumbnailRendition"],a.$inject=["$resource","config","CacheFactory","$rootScope","users","srcSet","fixProtocol"],c.$inject=["$resource","config"],u.$inject=["$resource","config"],l.$inject=["$resource","config"],d.$inject=["$resource","config"],e.module("liveblog-embed").service("users",o).service("posts",a).service("blogs",i).service("comments",c).service("items",u).service("outputs",l).service("advertisements",d).factory("transformBlog",r).factory("srcSet",t).factory("thumbnailRendition",n)}(angular),function(e){"use strict";function t(e){return e.replace(/(<([^>]+)>)/gi,"")}function n(e,t,n,r){function i(i,o){this.send=function(i){var o=n.defer();return i.client_blog=r.blog._id,i.item_type="comment",t.save(i).$promise.then(function(t){if("ERR"===t._status)return void o.reject("Try again later!");var n={post_status:"comment",client_blog:r.blog._id,groups:[{id:"root",refs:[{idRef:"main"}],role:"grpRole:NEP"},{id:"main",refs:[{residRef:t._id}],role:"grpRole:Main"}]};e.save(n).$promise.then(function(e){return"ERR"===e._status?void o.reject("Try again later!"):void o.resolve(e)})},function(e){o.reject("Try again later!")}),o.promise}}return i}function r(n,r,i){var o=n,s=new i;e.extend(o,{modal:!0,notify:!1,form:!0,reset:function(){o.form||(o.commenter=void 0,o.content=void 0)},toggle:function(e){o.notify?(o.notify=!1,o.form=!1,o.modal=!1,o.reset()):(o.modal=!o.modal,o.form=!o.form,o.reset())},send:function(){return!o.commenter||o.commenter.length<3||o.commenter.length>30||!o.content||o.content.length<3||o.content.length>300?(o.commenter=void 0===o.commenter?"":o.commenter,o.content=void 0===o.content?"":o.content,!1):(o.notify="sended",o.form=!1,void s.send({commenter:t(o.commenter),text:t(o.content)}).then(function(){o.reset(),r(function(){o.notify&&(o.notify=!1,o.form=!0,o.comment=!1)},2500)}))}})}n.$inject=["comments","items","$q","config"],r.$inject=["$scope","$timeout","CommentsManager"],e.module("liveblog-embed").factory("CommentsManager",n).directive("lbComments",["$timeout","asset",function(e,t){return{scope:{comment:"="},templateUrl:t.templateUrl("views/comments.html"),controller:r,link:function(e,t,n){e.comment=!1,e.$watch("comment",e.toggle)}}}])}(angular),function(e){"use strict";function t(t,n,r,i){function o(o,s,a){function c(){D.pagesLoaded=0,D.newUpdatesApplied=0,D.uncountedPosts=[],D.countedPosts=[]}function u(e){return{posts:e||[],addPost:function(e){this.posts.push(e)}}}function l(e,n){var r=D.highlight?{filtered:{filter:{and:[{term:{sticky:a}},{term:{post_status:"open"}},{term:{lb_highlight:!0}},{not:{term:{deleted:!0}}}]}}}:{filtered:{filter:{and:[{term:{sticky:a}},{term:{post_status:"open"}},{not:{term:{deleted:!0}}}]}}},i={source:{query:r,sort:[C[D.sort]]},page:e,max_results:n||D.maxResults};return t.get(i).$promise.then(function(e){return D.meta=e._meta,e})}function d(e){return D.highlight=e,D.pages=[],c(),m()}function f(e){return D.sort=e,D.pages=[],c(),m()}function p(e){return e?void(D.sort=e):D.sort}function m(){var e=n.when();return 0===D.pages.length&&(c(),e=D.retrieveUpdate().then(function(e){w(e._items)})),e.then(function(){var e=g();return D.pagesLoaded=D.pagesLoaded+1+e,x(D.pagesLoaded)})}function g(){var e,t;return e="oldest_first"===D.sort?D.newUpdatesApplied:D.newUpdatesApplied+D.uncountedPosts.length,D.countedPosts=D.countedPosts.concat(D.uncountedPosts),D.uncountedPosts=[],D.newUpdatesApplied=0,t=Math.floor(e/D.maxResults)}function h(r){var i=D.latestUpdatedDate?D.latestUpdatedDate.utc().format():void 0,o={page:1,source:{sort:[{_updated:{order:"desc"}}],query:{filtered:{filter:{and:[{range:{_updated:{gt:i}}}]}}}}};return t.get(o).$promise.then(function(r){var s=r._meta;if(s.total<=s.max_results*s.page||!e.isDefined(i))return r;for(var a=[],c=s.page+1;c<=Math.floor(s.total/s.max_results)+1;c++)o.page=c,a.push(t.get(o).$promise);return n.all(a).then(function(t){return e.extend({},t[0],{_items:[].concat.apply([],t.map(function(e){return e._items})),_meta:e.extend(s,{max_results:s.max_results*t.length})})})}).then(function(e){return e})}function v(e,t){t=t===!0;var n=y(e._items,t);return 0!==D.pages.length&&b(e._items),n}function b(t){t.forEach(function(t){var n=P(t);e.isDefined(n)||t.deleted||"open"!==t.post_status||t.sticky!==a||D.uncountedPosts.push(t)})}function y(t,n){var r=[];return t.forEach(function(t){var i=P(t);e.isDefined(i)?t.deleted?(E(t),D.newUpdatesApplied--):"open"!==t.post_status||t.sticky!==a||D.highlight&&!t.lb_highlight?(E(t),D.newUpdatesApplied--):(D.pages[i[0]].posts[i[1]]=t,$(D.allPosts(),!0)):t.deleted||"open"!==t.post_status||t.sticky!==a||(n?(U(t),D.countedPosts.indexOf(t)===-1&&"oldest_first"!==D.sort&&D.newUpdatesApplied++):r.push(t))}),n&&(D.countedPosts=[]),w(t),r}function w(t){var n;t.forEach(function(t){n=moment(t._updated),e.isDefined(D.latestUpdatedDate)?D.latestUpdatedDate.diff(n)<0&&(D.latestUpdatedDate=n):D.latestUpdatedDate=n})}function $(t,n){t=t||D.allPosts(),n&&(D.pages=[]);var r=Object.keys(C[D.sort])[0],o=C[D.sort][r].order;t=_.orderBy(t,r,o);var s,a=!1;t.forEach(function(t,n){n%D.maxResults===0&&(s=new u),s.addPost(t),s.posts.length===D.maxResults&&(R(s),s=void 0),e.forEach(t.groups[1].refs,function(e){e.item&&"embed"===e.item.item_type&&e.item.text&&e.item.text.indexOf("platform.instagram.com")!==-1&&(a=!0)})}),e.isDefined(s)&&R(s),a&&i(function(){window.instgrm.Embeds.process()},1e3)}function x(t){t=t||D.pages.length;var n=[];return l(t).then(function(t){return _.forEach(t._items,function(t){var r=P(t);e.isDefined(r)||n.push(t)}),$(n,!1),t})}function P(e){for(var t,n=0;n<D.pages.length;n++){t=D.pages[n];for(var r=0;r<t.posts.length;r++)if(t.posts[r]._id===e._id)return[n,r]}}function U(t){var n=D.allPosts();e.isArray(t)||(t=[t]),t.forEach(function(t){e.isDefined(P(t))||n.push(t)}),$(n,!0),w(n)}function E(t){var n=P(t);if(e.isDefined(t)){var r=n[0],i=n[1];D.pages[r].posts.splice(i,1),$(D.allPosts(),!0)}}function R(e){D.pages.push(e)}var C={editorial:{order:{order:"desc",missing:"_last",unmapped_type:"long"}},newest_first:{published_date:{order:"desc",missing:"_last",unmapped_type:"long"}},oldest_first:{published_date:{order:"asc",missing:"_last",unmapped_type:"long"}}},D=this;D.newUpdatesApplied=0,D.pagesLoaded=0,D.uncountedPosts=[],D.countedPosts=[],e.extend(D,{pages:[],meta:{},sort:s||r.settings.postOrder,changeHighlight:d,changeOrder:f,order:p,maxResults:o||r.settings.postsPerPage,latestUpdatedDate:void 0,fetchNewPage:m,retrieveUpdate:h,processUpdates:v,applyUpdates:y,updateLatestDates:w,allPosts:function(){var e=D.pages.map(function(e){return e.posts.map(function(e){return e})}),t=[];return t.concat.apply(t,e)}})}return o}t.$inject=["posts","$q","config","$timeout"],e.module("liveblog-embed").factory("PagesManager",t)}(angular),function(e){"use strict";e.module("liveblog-embed").factory("Permalink",["$q","$timeout","config",function(t,n,r){return function(r,i){function o(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")}var s,a="liveblog._id",c=i;if(document.parent)try{s=document.location.href}catch(u){s=document.referrer}else s=document.location.href;var l,d=new RegExp(o(a)+"=([^&#]*)"),l=s.match(d);if(l){var f=decodeURIComponent(l[1]).split("->");this._id=f[0],r.order(f[1])}this.get=function(e){var t=!1,n=a+"="+e+"->"+r.order();if(s.indexOf(c)===-1)t=s+c+n;else if(s.indexOf(a+"=")!==-1){var i=new RegExp(o(a)+"=[^&#]*");t=s.replace(i,n)}else t=s+"&"+n;return t},this.loadPost=function(){var i=t.defer(),o=this,s=!1;return o._id?(e.forEach(r.allPosts(),function(e){e._id===o._id&&(s=!0)}),s?n(function(){i.resolve(o._id)}):r.fetchNewPage().then(function(){o.loadPost()})):i.reject(),i.promise}}}])}(angular),function(e){"use strict";e.module("liveblog-embed").factory("fixProtocol",["config",function(e){return function(t){var n=RegExp(/http(s)?:\/\//gi);e.api_host.split("//").pop();return e.api_host.replace(n,"//"),t.replace(n,"//"),t.replace(n,"//")}}]).provider("asset",["$injector",function(e){this.templateUrl=function(t){var n=e.get("config"),r=e.has("assets_simplified_path")&&e.get("assets_simplified_path"),i=t;return n.debug&&n.templates&&n.templates[t]?n.templates[t]:!n.debug&&r?i:(/^(https?:\/\/|\/\/)/.test(t)||(i=n.assets_root+"/"+i),i=i.replace(/[^\/]+\/+\.\.\//g,"/").replace(/\.\//g,"").replace(/(\w)\/\/(\w)/g,"$1/$2"))},this.imageUrl=this.templateUrl,this.$get=function(){return this}}])}(angular),function(e){"use strict";e.module("liveblog-embed").directive("lbBindHtml",[function(){return{restrict:"A",link:function(e,t,n){n.$observe("htmlContent",function(){n.htmlLocation?t.find("["+n.htmlLocation+"]").html(n.htmlContent):t.html(n.htmlContent)})}}}]).directive("lbFluidIframe",["$timeout","$window",function(t,n){return{restrict:"EA",link:function(r,i,o){function s(){var e=i.innerWidth();e<a.attr("width")&&a.width(e).height(e*a.data("aspectRatio"))}var a;t(function(){a=i.find("iframe"),a.data("aspectRatio",a.attr("height")/a.attr("width")),s()},1e3),e.element(n).bind("resize",_.debounce(s,1e3))}}}]).directive("lbTwitterCard",[function(){return{restrict:"E",link:function(e,t,n){t.html(n.lbTwitterContent)}}}]).directive("lbGenericEmbed",["$timeout","$window","asset",function(e,t,n){return{scope:{item:"="},templateUrl:n.templateUrl("views/generic-embed.html")}}]).directive("lbDropdown",["$rootScope","asset",function(e,t){return{restrict:"E",templateUrl:t.templateUrl("views/dropdown.html"),scope:{placeholder:"@",list:"=",selected:"&",order:"&"},link:function(t){t.listVisible=!1,t.isPlaceholder=!0,t.select=function(e){t.isPlaceholder=!1,t.order({order:e.order}),t.listVisible=!1},t.isSelected=function(e){return e.order===t.selected()},t.show=function(){t.listVisible=!0},e.$on("documentClicked",function(e,n){(0==$(n[0]).parents(".dropdown-display").length||$(n[0]).parents(".dropdown-display.clicked").length>0)&&t.$apply(function(){t.listVisible=!1})}),t.$watch("selected()",function(e){_.each(t.list,function(e){e.order===t.selected()&&(t.display=e.name,t.isPlaceholder=!1)})})}}}])}(angular),function(e){"use strict";e.module("liveblog-embed").filter("varname",["config",function(e){return function(e){return e&&e.toLowerCase().replace(" ","_")}}]).filter("prettifyIsoDate",["config",function(e){return function(t){return moment(t).format(e.settings.datetimeFormat)}}]).filter("outboundAnchors",function(){return function(e){return e.replace(/<a([^>]*)>/g,function(e,t){return t.indexOf("target")===-1?"<a"+t+' target="_blank">':e})}}).filter("convertLinksWithRelativeProtocol",["fixProtocol",function(e){return e}]).filter("fixEmbed",["config",function(e){return function(t){return e.settings.livestream&&e.settings.livestreamAutoplay&&(t=t.replace(/src\w*=\w*("|')?([^\"\']+)("|')/,function(e,t,n){var r="?";return n.indexOf("?")!==-1&&(r="&"),'src="'+n+r+'rel=0&autoplay=1"'})),t.indexOf("youtube")!==-1&&(t=t.replace(/width\s*=\s*("|')?([\d]+)("|')?/g,'width="100%"')),t.replace(/<blockquote class="instagram-media"[^>]*/g,function(e){return e.replace(/ max-width:[^;]*;/,"").replace(/ width:[^;]*;/," width: 96%;")})}}]).filter("fixMarkup",function(){var e=[/<\/?span>/g,/<(\/?)div([^>]+)>/g,/<([^>]+)><br><\/([^>]+)>/g,/<([^>]+)><\/([^>]+)>/g,/(<p>)+/,/&nbsp;/g],t=["","<$1p$2>",function(e,t,n){return"<"+t+"></"+n+">"},function(e,t,n){return t===n?"":e},"<p>"," "];return function(n){return e.forEach(function(e,r){n=n.replace(e,t[r])}),n}})}(angular);